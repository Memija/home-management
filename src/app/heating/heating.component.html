<div class="page-container">
  <div class="app-header">
    <div class="header-left">
      <h1>{{ 'HEATING.TITLE' | translate }}</h1>
    </div>
  </div>

  <!-- Country Energy Facts - Incremental Mode -->
  @if (displayMode() === 'incremental') {
  <div class="comparison-note">
    <div class="comparison-content">
      <p>{{ 'HEATING.ENERGY_FACTS_FOR' | translate:{ country: selectedCountryName() } }}</p>
      <div class="country-selector">
        <label for="heating-comparison-country">
          <span class="info-tooltip-container">
            <lucide-icon [img]="InfoIcon" size="14" class="info-icon"></lucide-icon>
            <span class="info-tooltip">{{ 'HEATING.SELECT_COUNTRY_INFO' | translate }}</span>
          </span>
          {{ 'CHART.COMPARE_WITH' | translate }}:
        </label>
        <div class="select-with-flag">
          <select id="heating-comparison-country" [value]="selectedCountryCode()"
            (change)="onCountryChange($any($event.target).value)">
            @for (country of availableCountries; track country.code) {
            <option [value]="country.code" [selected]="country.code === selectedCountryCode()">
              {{ country.nameKey | translate }}
            </option>
            }
          </select>
        </div>
      </div>
    </div>

    <!-- Country Fun Fact -->
    @if (heatingFact()) {
    <div class="country-fact">
      <lucide-icon [img]="LightbulbIcon" size="20" class="fact-icon"></lucide-icon>
      <div class="fact-content">
        <div class="fact-label">{{ heatingFact()!.title }}</div>
        <p class="fact-text">{{ heatingFact()!.message }}</p>
      </div>
      <button type="button" class="refresh-btn" (click)="refreshFact()" title="{{ 'CHART.NEW_FACT' | translate }}">
        ↻
      </button>
    </div>
    }
  </div>
  }

  <!-- Historical Facts - Total Mode -->
  @if (displayMode() === 'total' && heatingFact()) {
  <div class="notification-card notification-card--info">
    <div class="notification-content">
      <lucide-icon [img]="LightbulbIcon" size="20" class="notification-icon"></lucide-icon>
      <div class="notification-text">
        <strong>{{ heatingFact()!.title }}</strong>
        <p>{{ heatingFact()!.message }}</p>
      </div>
    </div>
  </div>
  }

  <app-consumption-chart [data]="chartRecords()" [currentView]="chartView()" [onViewChange]="onChartViewChange"
    [chartType]="'heating'" [displayMode]="displayMode()" [onDisplayModeChange]="onDisplayModeChange">
  </app-consumption-chart>

  <app-detailed-records [records]="records()" [calculateTotalFn]="calculateTotal"
    [valuesNoteKey]="'HEATING.ALL_VALUES_IN_UNIT'" [sortOptions]="heatingSortOptions"
    (editRecord)="onEditRecord($event)" (deleteRecord)="onDeleteRecord($event)"
    (deleteAllRecords)="onDeleteAllRecords($event)">
    <!-- Import/Export buttons projected into detailed-records -->
    <div slot="action-buttons" class="action-buttons-group">
      <button type="button" (click)="exportData()" class="export-btn json-btn"
        [disabled]="isExporting() || records().length === 0"
        title="{{ (records().length === 0 ? 'HEATING.EXPORT_DISABLED_TOOLTIP' : 'HEATING.EXPORT') | translate }}">
        <lucide-icon [img]="DownloadIcon" size="16"></lucide-icon>
        <span class="btn-text">{{ isExporting() ? 'Exporting...' : ('HEATING.EXPORT' | translate) }}</span>
      </button>
      <label for="import-file-heating" class="import-btn json-btn" [class.disabled]="isImporting()"
        title="{{ 'HEATING.IMPORT' | translate }}">
        <lucide-icon [img]="UploadIcon" size="16"></lucide-icon>
        <span class="btn-text">{{ isImporting() ? 'Importing...' : ('HEATING.IMPORT' | translate) }}</span>
        <input type="file" id="import-file-heating" accept=".json" (change)="importData($event)" class="hidden-input"
          [disabled]="isImporting()">
      </label>

      <!-- Excel Export/Import (conditional) -->
      @if (excelSettings.isEnabled()) {
      <button type="button" (click)="exportToExcel()" class="export-btn excel-btn"
        [disabled]="isExporting() || records().length === 0"
        title="{{ (records().length === 0 ? 'HEATING.EXPORT_DISABLED_TOOLTIP' : 'HEATING.EXPORT_EXCEL') | translate }}">
        <lucide-icon [img]="FileSpreadsheetIcon" size="16"></lucide-icon>
        <span class="btn-text">{{ isExporting() ? 'Exporting...' : ('HEATING.EXPORT_EXCEL' | translate) }}</span>
      </button>
      <label for="import-excel-file-heating" class="import-btn excel-btn" [class.disabled]="isImporting()"
        title="{{ 'HEATING.IMPORT_EXCEL' | translate }}">
        <lucide-icon [img]="FileSpreadsheetIcon" size="16"></lucide-icon>
        <span class="btn-text">{{ isImporting() ? 'Importing...' : ('HEATING.IMPORT_EXCEL' | translate) }}</span>
        <input type="file" id="import-excel-file-heating" accept=".xlsx,.xls" (change)="importFromExcel($event)"
          class="hidden-input" [disabled]="isImporting()">
      </label>
      }
    </div>
    <!-- Heating-specific record details template -->
    <ng-template #recordDetails let-record>
      @for (room of roomsService.rooms(); track room.id) {
      <div class="room-value">
        <strong>{{ room.name }}:</strong>
        <span>{{ record.rooms[room.id] || 0 }} kWh</span>
      </div>
      }
    </ng-template>
  </app-detailed-records>

  <app-error-modal [show]="showErrorModal()" [title]="errorTitle()" [message]="errorMessage()"
    [details]="errorDetails()" [instructions]="errorInstructions()" (cancel)="closeErrorModal()" [type]="errorType()">
  </app-error-modal>

  <app-consumption-input [groups]="consumptionGroups()" [selectedDate]="selectedDate()" [maxDate]="maxDate"
    [editingMode]="!!editingRecord()" [dateExists]="dateExists()" [titleKey]="'HEATING.RECORD_CONSUMPTION'"
    [allowPartialGroups]="true" [layoutMode]="'flat'" [helpSteps]="helpSteps"
    [helpTitleKey]="'HEATING.RECORD_HELP_TITLE'" [noValuesErrorKey]="'HEATING.NO_VALUES_ERROR'"
    [incompleteRoomErrorKey]="'HEATING.INCOMPLETE_ROOM_ERROR'" (dateChange)="selectedDate.set($event)"
    (fieldChange)="onFieldChange($event)" (save)="onConsumptionSave($event)" (cancel)="cancelEdit()">
    <button header-actions type="button" class="settings-btn" (click)="openRoomsModal()"
      title="{{ 'HEATING.ROOMS_SETTINGS_TITLE' | translate }}">
      <lucide-icon [img]="SettingsIcon" size="20"></lucide-icon>
    </button>
  </app-consumption-input>
</div>

<app-confirmation-modal [show]="showImportConfirmModal()" [titleKey]="'HOME.IMPORT_CONFIRM_TITLE'"
  [messageKey]="'HOME.IMPORT_CONFIRM_MESSAGE'" [cancelKey]="'HOME.CANCEL'" [confirmKey]="'HOME.IMPORT_BUTTON'"
  [icon]="UploadIcon" (confirm)="confirmImport()" (cancel)="cancelImport()">
</app-confirmation-modal>

<app-heating-rooms-modal [show]="showRoomsModal()" [rooms]="roomsService.rooms()" [roomsWithDataArray]="roomsWithData()"
  (save)="onRoomsSave($event)" (cancel)="onRoomsCancel()">
</app-heating-rooms-modal>
@if (showSuccessModal()) {
<div class="modal-overlay" (click)="closeSuccessModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <lucide-icon [img]="CheckCircleIcon" size="32" class="success-icon"></lucide-icon>
      <h3>{{ 'HOME.SUCCESS_TITLE' | translate }}</h3>
      <button class="close-btn" (click)="closeSuccessModal()">×</button>
    </div>
    <div class="modal-body">
      <p>{{ 'HOME.RECORD_SAVED' | translate }}</p>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" (click)="closeSuccessModal()">OK</button>
    </div>
  </div>
</div>
}