<div class="page-container">
  <div class="app-header">
    <div class="header-left">
      <h1>{{ 'HEATING.TITLE' | translate }}</h1>
    </div>
  </div>

  <!-- New Room Spike Notification -->
  @if (unconfirmedSpike()) {
  <div class="notification-card notification-card--warning">
    <div class="notification-content">
      <lucide-icon [img]="AlertTriangleIcon" size="20" class="notification-icon"></lucide-icon>
      <div class="notification-text">
        <strong>{{ 'HEATING.NEW_ROOM_DETECTED_TITLE' | translate }}</strong>
        <p>{{ 'HEATING.NEW_ROOM_DETECTED_MESSAGE' | translate:{ room: unconfirmedSpikeRoomName(), date:
          formattedSpikeDate() } }}</p>
      </div>
    </div>
    <div class="notification-actions">
      <button type="button" class="btn-confirm" (click)="confirmSpike(unconfirmedSpike()!)">
        {{ 'HEATING.CONFIRM_NEW_ROOM' | translate }}
      </button>
      <button type="button" class="btn-dismiss" (click)="dismissSpike(unconfirmedSpike()!)">
        {{ 'HEATING.DISMISS_NEW_ROOM' | translate }}
      </button>
    </div>
  </div>
  }

  <!-- Country Energy Facts - Incremental Mode -->
  @if (displayMode() === 'incremental') {
  <app-comparison-note [type]="'heating'" [records]="chartRecords()" [chartView]="chartView()"
    [heatingCountries]="availableCountries" (countryCodeChange)="onCountryChange($event)">
  </app-comparison-note>
  }

  <!-- Historical Facts - Total Mode -->
  @if (displayMode() === 'total' && heatingFact()) {
  <div class="notification-card notification-card--info">
    <div class="notification-content">
      <lucide-icon [img]="LightbulbIcon" size="20" class="notification-icon"></lucide-icon>
      <div class="notification-text">
        <strong>{{ heatingFact()!.title }}</strong>
        <p>{{ heatingFact()!.message }}</p>
      </div>
    </div>
    <div class="notification-actions">
      <button type="button" class="refresh-btn" (click)="refreshFact()" title="{{ 'CHART.NEW_FACT' | translate }}">
        ↻
      </button>
    </div>
  </div>
  }

  <app-consumption-chart [data]="chartRecords()" [currentView]="chartView()" [onViewChange]="onChartViewChange"
    [chartType]="'heating'" [displayMode]="displayMode()" [onDisplayModeChange]="onDisplayModeChange"
    [roomNames]="chartRoomNames()" [roomIds]="chartRoomIds()" [roomColors]="chartRoomColors()"
    [country]="selectedCountryCode()" [ignoredSpikes]="confirmedSpikes()" [helpSteps]="chartHelpSteps">
  </app-consumption-chart>

  <app-detailed-records [records]="records()" [calculateTotalFn]="calculateTotal" [valuesNoteKey]="''"
    [recordType]="'heating'" [sortOptions]="heatingSortOptions" [helpSteps]="recordsHelpSteps"
    (editRecord)="onEditRecord($event)" (deleteRecord)="onDeleteRecord($event)"
    (deleteAllRecords)="onDeleteAllRecords($event)">
    <!-- Import/Export buttons projected into detailed-records -->
    <div slot="action-buttons" class="action-buttons-group">
      <button type="button" (click)="exportData()" class="export-btn json-btn"
        [disabled]="isExporting() || records().length === 0"
        title="{{ (records().length === 0 ? 'HEATING.EXPORT_DISABLED_TOOLTIP' : 'HEATING.EXPORT') | translate }}">
        <lucide-icon [img]="DownloadIcon" size="16"></lucide-icon>
        <span class="btn-text">{{ isExporting() ? 'Exporting...' : ('HEATING.EXPORT' | translate) }}</span>
      </button>
      <label for="import-file-heating" class="import-btn json-btn" [class.disabled]="isImporting()"
        title="{{ 'HEATING.IMPORT' | translate }}">
        <lucide-icon [img]="UploadIcon" size="16"></lucide-icon>
        <span class="btn-text">{{ isImporting() ? 'Importing...' : ('HEATING.IMPORT' | translate) }}</span>
        <input type="file" id="import-file-heating" accept=".json" (change)="importData($event)" class="hidden-input"
          [disabled]="isImporting()">
      </label>

      <!-- Excel Export/Import (conditional) -->
      @if (excelSettings.isEnabled()) {
      <button type="button" (click)="exportToExcel()" class="export-btn excel-btn"
        [disabled]="isExporting() || records().length === 0"
        title="{{ (records().length === 0 ? 'HEATING.EXPORT_DISABLED_TOOLTIP' : 'HEATING.EXPORT_EXCEL') | translate }}">
        <lucide-icon [img]="FileSpreadsheetIcon" size="16"></lucide-icon>
        <span class="btn-text">{{ isExporting() ? 'Exporting...' : ('HEATING.EXPORT_EXCEL' | translate) }}</span>
      </button>
      <label for="import-excel-file-heating" class="import-btn excel-btn" [class.disabled]="isImporting()"
        title="{{ 'HEATING.IMPORT_EXCEL' | translate }}">
        <lucide-icon [img]="FileSpreadsheetIcon" size="16"></lucide-icon>
        <span class="btn-text">{{ isImporting() ? 'Importing...' : ('HEATING.IMPORT_EXCEL' | translate) }}</span>
        <input type="file" id="import-excel-file-heating" accept=".xlsx,.xls" (change)="importFromExcel($event)"
          class="hidden-input" [disabled]="isImporting()">
      </label>
      <button type="button" (click)="exportToPdf()" class="export-btn pdf-btn"
        [disabled]="isExporting() || records().length === 0"
        title="{{ (records().length === 0 ? 'HEATING.EXPORT_DISABLED_TOOLTIP' : 'HEATING.EXPORT_PDF') | translate }}">
        <lucide-icon [img]="FileTextIcon" size="16"></lucide-icon>
        <span class="btn-text">{{ isExporting() ? 'Exporting...' : ('HEATING.EXPORT_PDF' | translate) }}</span>
      </button>
      }
    </div>
    <!-- Heating-specific record details template -->
    <ng-template #recordDetails let-record>
      <div class="room-values-container">
        @for (room of roomsService.rooms(); track room.id) {
        <div class="room-value">
          <span class="room-name">{{ room.name }}</span>
          <span class="room-reading">{{ record.rooms[room.id] || 0 }}</span>
        </div>
        }
      </div>
    </ng-template>
  </app-detailed-records>

  <app-error-modal [show]="showErrorModal()" [title]="errorTitle()" [message]="errorMessage()"
    [details]="errorDetails()" [instructions]="errorInstructions()" (cancel)="closeErrorModal()" [type]="errorType()">
  </app-error-modal>

  <app-consumption-input [groups]="consumptionGroups()" [selectedDate]="selectedDate()" [maxDate]="maxDate"
    [editingMode]="!!editingRecord()" [dateExists]="dateExists()" [titleKey]="'HEATING.RECORD_CONSUMPTION'"
    [allowPartialGroups]="true" [layoutMode]="'flat'" [helpSteps]="helpSteps"
    [helpTitleKey]="'HEATING.RECORD_HELP_TITLE'" [noValuesErrorKey]="'HEATING.NO_VALUES_ERROR'"
    [incompleteRoomErrorKey]="'HEATING.INCOMPLETE_ROOM_ERROR'" (dateChange)="selectedDate.set($event)"
    (fieldChange)="onFieldChange($event)" (save)="onConsumptionSave($event)" (cancel)="cancelEdit()">
    <button header-actions type="button" class="settings-btn" (click)="openRoomsModal()"
      title="{{ 'HEATING.ROOMS_SETTINGS_TITLE' | translate }}">
      <lucide-icon [img]="SettingsIcon" size="20"></lucide-icon>
    </button>
  </app-consumption-input>
</div>

<app-confirmation-modal [show]="showImportConfirmModal()" [titleKey]="'HOME.IMPORT_CONFIRM_TITLE'"
  [messageKey]="'HOME.IMPORT_CONFIRM_MESSAGE'" [cancelKey]="'HOME.CANCEL'" [confirmKey]="'HOME.IMPORT_BUTTON'"
  [icon]="UploadIcon" (confirm)="confirmImport()" (cancel)="cancelImport()">
</app-confirmation-modal>

<app-heating-rooms-modal [show]="showRoomsModal()" [rooms]="roomsService.rooms()" [roomsWithDataArray]="roomsWithData()"
  (save)="onRoomsSave($event)" (cancel)="onRoomsCancel()">
</app-heating-rooms-modal>
@if (showSuccessModal()) {
<div class="modal-overlay" (click)="closeSuccessModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <lucide-icon [img]="CheckCircleIcon" size="32" class="success-icon"></lucide-icon>
      <h3>{{ successTitle() | translate }}</h3>
      <button class="close-btn" (click)="closeSuccessModal()">×</button>
    </div>
    <div class="modal-body">
      <p>{{ successMessage() | translate }}</p>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" (click)="closeSuccessModal()">OK</button>
    </div>
  </div>
</div>
}

<app-delete-confirmation-modal [show]="showDeleteModal()" [titleKey]="'HOME.DELETE_CONFIRM_TITLE'"
  [messageKey]="'HOME.DELETE_CONFIRM_MESSAGE'" [cancelKey]="'HOME.CANCEL'" [deleteKey]="'HOME.DELETE_BUTTON'"
  [icon]="TrashIcon" (confirm)="confirmDelete()" (cancel)="cancelDelete()">
</app-delete-confirmation-modal>

<app-delete-confirmation-modal [show]="showDeleteAllModal()" [titleKey]="'HOME.DELETE_ALL_CONFIRM_TITLE'"
  [messageKey]="deleteAllMessageKey()" [messageParams]="deleteAllMessageParams()" [cancelKey]="'HOME.CANCEL'"
  [deleteKey]="'HOME.DELETE_ALL_BUTTON'" [icon]="TrashIcon" (confirm)="confirmDeleteAll()" (cancel)="cancelDeleteAll()">
</app-delete-confirmation-modal>
