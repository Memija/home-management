<div class="container">
  <div class="app-header">
    <div class="header-left">
      <button type="button" routerLink="/" class="btn-outline" title="{{ 'DASHBOARD.BACK_TO_DASHBOARD' | translate }}">
        <lucide-icon [img]="ArrowLeftIcon" size="16"></lucide-icon>
        {{ 'DASHBOARD.BACK_TO_DASHBOARD' | translate }}
      </button>
      <h1>{{ 'WATER.TITLE' | translate }}</h1>
    </div>

  </div>

  @if (familySize() > 0 && displayMode() === 'incremental') {
  <div class="comparison-note" [class.disabled]="!hasSufficientDataForComparison()">
    <div class="comparison-content">
      @if (hasSufficientDataForComparison()) {
      <p>{{ 'CHART.COMPARISON_NOTE_COUNTRY' | translate:{ country: effectiveComparisonCountryName(), average:
        countryAverage(), size: familySize() } }}</p>
      } @else {
      <p class="disabled-message">
        <lucide-icon [img]="InfoIcon" size="16" class="info-icon"></lucide-icon>
        {{ 'CHART.COMPARISON_REQUIRES_DATA' | translate }}
      </p>
      }
      <div class="country-selector" [class.disabled]="!hasSufficientDataForComparison()">
        <label for="comparison-country" [class.disabled]="!hasSufficientDataForComparison()">
          <span class="info-tooltip-container">
            <lucide-icon [img]="InfoIcon" size="14" class="info-icon"></lucide-icon>
            <span class="info-tooltip">{{ hasSufficientDataForComparison() ? ('CHART.COMPARE_WITH_INFO' | translate) :
              ('CHART.COMPARISON_REQUIRES_DATA' | translate) }}</span>
          </span>
          {{ 'CHART.COMPARE_WITH' | translate }}:
        </label>
        <div class="select-with-flag" [class.disabled]="!hasSufficientDataForComparison()">
          <img [src]="getSelectedCountryFlag()" alt="" class="country-flag" />
          <select id="comparison-country" [value]="effectiveComparisonCountryCode()"
            (change)="onComparisonCountryChange($any($event.target).value)"
            [disabled]="!hasSufficientDataForComparison()">
            @for (country of availableCountries(); track country.code) {
            <option [value]="country.code"
              [selected]="country.code.toLowerCase() === effectiveComparisonCountryCode().toLowerCase()">
              {{ country.translationKey | translate }} ({{ country.average }} L)
            </option>
            }
          </select>
        </div>
      </div>
    </div>
  </div>
  }

  <app-consumption-chart [data]="records()" [currentView]="chartView()" [onViewChange]="onChartViewChange"
    [chartType]="'water'" [displayMode]="displayMode()" [onDisplayModeChange]="onDisplayModeChange"
    [familySize]="familySize()" [country]="effectiveComparisonCountryCode()">
  </app-consumption-chart>


  <app-detailed-records [records]="records()" [defaultSortOption]="'date-desc'" [showSearchDate]="true"
    [showYearMonth]="true" [showEditDelete]="true" [recordType]="'water'" (editRecord)="editRecord($event)"
    (deleteRecord)="deleteRecord($event)" (deleteAllRecords)="deleteAllRecords($event)">
    <!-- Import/Export buttons projected into detailed-records -->
    <div slot="action-buttons" class="action-buttons-group">
      <button type="button" (click)="exportData()" class="export-btn" [disabled]="isExporting()"
        title="{{ 'WATER.EXPORT' | translate }}">
        <lucide-icon [img]="DownloadIcon" size="16"></lucide-icon>
        {{ isExporting() ? 'Exporting...' : ('WATER.EXPORT' | translate) }}
      </button>
      <label for="import-file" class="import-btn" [class.disabled]="isImporting()"
        title="{{ 'WATER.IMPORT' | translate }}">
        <lucide-icon [img]="UploadIcon" size="16"></lucide-icon>
        {{ isImporting() ? 'Importing...' : ('WATER.IMPORT' | translate) }}
        <input type="file" id="import-file" accept=".json" (change)="importData($event)" class="hidden-input"
          [disabled]="isImporting()">
      </label>

      <!-- Excel Export/Import (conditional) -->
      <button *ngIf="excelSettings.isEnabled()" type="button" (click)="exportToExcel()" class="export-btn excel-btn"
        [disabled]="isExporting()" title="{{ 'WATER.EXPORT_EXCEL' | translate }}">
        <lucide-icon [img]="FileSpreadsheetIcon" size="16"></lucide-icon>
        {{ isExporting() ? 'Exporting...' : ('WATER.EXPORT_EXCEL' | translate) }}
      </button>
      <label *ngIf="excelSettings.isEnabled()" for="import-excel-file" class="import-btn excel-btn"
        [class.disabled]="isImporting()" title="{{ 'WATER.IMPORT_EXCEL' | translate }}">
        <lucide-icon [img]="FileSpreadsheetIcon" size="16"></lucide-icon>
        {{ isImporting() ? 'Importing...' : ('WATER.IMPORT_EXCEL' | translate) }}
        <input type="file" id="import-excel-file" accept=".xlsx,.xls" (change)="importFromExcel($event)"
          class="hidden-input" [disabled]="isImporting()">
      </label>
    </div>
  </app-detailed-records>

  <app-consumption-input [groups]="consumptionGroups()" [selectedDate]="selectedDate()" [maxDate]="maxDate"
    [editingMode]="!!editingRecord()" [dateExists]="dateExists()" (dateChange)="selectedDate.set($event)"
    (fieldChange)="onFieldChange($event)" (save)="onConsumptionSave($event)" (cancel)="cancelEdit()">
  </app-consumption-input>
</div>

@if (showSuccessModal()) {
<div class="modal-overlay" (click)="closeSuccessModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <lucide-icon [img]="CheckCircleIcon" size="32" class="success-icon"></lucide-icon>
      <h3>{{ 'HOME.SUCCESS_TITLE' | translate }}</h3>
      <button class="close-btn" (click)="closeSuccessModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <p>{{ 'HOME.RECORD_SAVED' | translate }}</p>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" (click)="closeSuccessModal()">OK</button>
    </div>
  </div>
</div>
}

<app-delete-confirmation-modal [show]="showDeleteModal()" [titleKey]="'HOME.DELETE_CONFIRM_TITLE'"
  [messageKey]="'HOME.DELETE_CONFIRM_MESSAGE'" [cancelKey]="'HOME.CANCEL'" [deleteKey]="'HOME.DELETE_BUTTON'"
  [icon]="TrashIcon" (confirm)="confirmDelete()" (cancel)="cancelDelete()">
</app-delete-confirmation-modal>

<app-delete-confirmation-modal [show]="showDeleteAllModal()" [titleKey]="'HOME.DELETE_ALL_CONFIRM_TITLE'"
  [messageKey]="deleteAllMessageKey()" [messageParams]="deleteAllMessageParams()" [cancelKey]="'HOME.CANCEL'"
  [deleteKey]="'HOME.DELETE_ALL_BUTTON'" [icon]="TrashIcon" (confirm)="confirmDeleteAll()" (cancel)="cancelDeleteAll()">
</app-delete-confirmation-modal>

<app-confirmation-modal [show]="showImportConfirmModal()" [titleKey]="'HOME.IMPORT_CONFIRM_TITLE'"
  [messageKey]="'HOME.IMPORT_CONFIRM_MESSAGE'" [cancelKey]="'HOME.CANCEL'" [confirmKey]="'HOME.IMPORT_BUTTON'"
  [icon]="UploadIcon" (confirm)="confirmImport()" (cancel)="cancelImport()">
</app-confirmation-modal>

<app-error-modal [show]="showErrorModal()" [title]="errorTitle()" [message]="errorMessage()" [details]="errorDetails()"
  [instructions]="errorInstructions()" (cancel)="closeErrorModal()" [type]="errorType()">
</app-error-modal>
